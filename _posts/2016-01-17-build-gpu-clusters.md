---
layout: post
author: Mu Li
categories: GPU
comments: true
title: GPU折腾手记——2015
---

整个2015年从折腾GPU开始，到折腾GPU结束。起因是比较穷，但又想搞点“大数据”，于是15年都是在下单，拆包裹，装机器，维护中。反过来看，为了省下那一点点钱却花费了大量时间，所以想写下来经验教训供各位DIY玩家参考。

这里GPU机器我是指使用多块GPU用来科学计算的机器，例如针对最近火热的深度学习，另外的两个GPU主要用途——游戏，挖矿——则不在此文讨论范围。而且此文主要针对对性价比敏感的人士，对于土豪人群，推荐大厂整体GPU集群解决方案，可省去大量力气。

## 买什么样的GPU

对于科学计算而言，性能主要取决于GPU的浮点运算能力。特别是对深度学习任务来说，主要是单精度浮点运算（未来对精度的需求可能更低，例如16bit精度）。而其他因素，例如CPU速度，内存大小，通讯带宽，对目前大多数深度学习任务而言则显得没那么重要，只要过了某个合理的阈值从而不是瓶颈就行。

对于GPU而言，简单来看有三个重要参数，浮点运算，价格与功耗。下面两个图比较了Nvidia Tesla，Geforce 700和900系列各卡的这三个参数。前两个参考了wikipedia，后面一个是查询了amazon/newegg上的当前价格。整体来看浮点运算和价格成正比。在价格上，不考虑为土豪设计的Tesla系列的话，其余的是一分价格一分货。

<img src="imgs/gpu-price.png" width=300px/>

目前的购买建议是优先考虑Titan X，但如果对于其12GB内存不是特别有兴趣的话，则考虑浮点运算性价比更好的980 TI（6GB 内存），如果嫌980 TI功耗比过高的话，则考虑980. 除非有特别的理由，个人不推荐980之下的卡了。因为达到同样的计算能力，使用更便宜的卡则会增加机器数量，可能导致其他配套成本（例如CPU，内存，电源，主板）和维护成本的增加。（下面将会有血与泪的教训）。

不过提醒一点是，GPU更新换代快，不宜大规模采购超出现在需求的机器。例如Nvidia下一代号称3D内存会带来新的加速，通常认为性价比更高的AMD也将会推出新的编译器来更好支持科学计算。

选好了GPU后变可以配套其他了。主要考虑的是供电和散热。例如一块卡可能有200w，4卡则800w了，加上CPU内存，电源至少要个1kw才行。其次GPU发热巨大，将多块GPU并排放会导致很严重的散热问题。还有，如果大量购买GPU机器，机房供电和散热也会是个大问题。

## 个人折腾手记

这里我分享一下15年折腾过的机器。背景是我们钱很少，能用来买机器的不超过5万刀。但手头有一些求来的硬件，例如Intel送了一打I5 CPU，Nvidia送了几块K40，一块Titan X，死皮要脸的问其他组要来一些淘汰的或者空闲的机器，拆了后往里面塞GPU。所以在实际花费可能不超过4万刀的情况下添置下面这些设备：

| CPU | GPU | mem | 网络 | 尺寸 | 数量 | 单台价格 |
| --- | --- | --- | --- | --- | --- | --- |
| i5-3470 | 2 x GTX 970 | 1G | mini tower | >10 | $1.3k |
| ? | 4 x K40 | 10G | 4U rack | 1 | ? |
| ? | 2 x GTX 980 | 2 x 40G | 2U | >10 | ? |
| ? | 4 x GTX 750 TI | 1G | full tower | 5 | |
| ? | 4 x GTX 980 | 10G | tower | 1 | |
| ？ | 4 x Titan X | 10G | 1U | 1 | 10k |

下面按购置时间顺序来逐一吐槽

### 双980

此集群是土豪系统组买的。配了CPU是当时最好，双40GB网络快到飞起，光交换机就花了10W刀。但买回来后半年没人拆封。我们厚脸皮的说我们帮你们装上，顺便出钱升级电源（750W->1.2KW）和买GPU，到时候共享给我们用一下就好了。下图是alex意外发现了这个未拆箱的集群，拆了一台过来看看。

这是我个人最爱集群，安装简单，2天全搞定。

网络快到飞起，很适合做分布式运算。但反过来说，CPU过于的好了，内存对于双卡来说过于大了，网络也是过于土豪，根本用不完。因为经常长时间跑大任务，我们很早的就把电源给烧了。。。

### 双970

情人节那天alex惊喜的掏出一板巧克力一样的东西，说“看，intel送的”。我当时就震惊了。后来发现原来是一打CPU，用冰箱里制冰块一样的板子，一个坑一块CPU。但CPU很弱，是n年前被淘汰的，所以我们准备去折腾个便宜的GPU集群。

下面是前三台订单，之后又陆续买了几台，然后忽悠别组老师也投资买了几台。有一整子组会都是装机大会。

这个集群的优点是单机便宜，十台机器差不多1W刀搞定（一个phd学生一年要花费老板10W+刀）。但由于是分多批买的，每次买都是挑当时最便宜的硬件，例如电源有4种，后来我们才发现电源接GPU线是不通用的。虽然GPU都是970，但来自4个不同的牌子，msi，evga, pny， gigabyte. 而且便宜硬件出错率也挺高，维护是个噩梦。另外一个问题是机箱占地方，大小基本等价一个4U的机器大小了，而且就插了2卡，而4U机器现在基本插8卡了。

### 四卡980

我最爱，也是折腾我最多的。第一个版本是长这样的，alex手艺高超的把整个机箱塞满了GPU，内存，硬盘。

结果发现散热是个大问题。一机箱太满，二机箱风扇不给力，三显卡风扇不给力。之后做了无数次测试，升级，期间烧坏了两快卡。这是目前的长相。机箱大了很多，前后装满了风扇，硬盘都卸了，第一块坏的卡送修了，第二块懒得动了，现在跛着脚跑。

### 四卡750 TI

这是dave用来挖矿的机器。一开始是裸的，就是主板接电源插GPU一字排开趟在dave的地下室挖矿，顺便当地暖用。后面挖矿不赚钱了后我们要来装上了机箱来重新利用一下。因为集群是pxe启动装centos，但这些机器用的游戏主板专为windows优化，而且又是来自不同厂家。花了整整两天才摸清怎么成功pxe启动，然而还是有一台现在都起不起来。

### 四卡K40机器

没有特别好说的，intel送了一个4U的机器，插上4快卡，半个小时搞定。但我觉得4U才插4卡，有点浪费空间。

### 四卡Titan X机器

刚买没几天。起因是上个月的NIPS我找N厂哭穷，N见我长得眉清目秀（误）送了一块卡。回来献给老板，老板因为国内某大厂赞助了些钱大手一挥补齐了剩下。Supermicro 1U塞了4快卡，里面的空间是寸土必争，装完后（整整一个下午）特别治愈强迫症。

因为空间狭小，所以风扇功率很大，噪音跟轰炸机一样。其中并列的三卡散热还行，另一块单独的卡温度明显比别人高。但目前来看没什么大碍。就是有点耗电，全力跑电流需要10A。

### 接下来？

因为已经有了些打底，接下来应该不会买超性价比机器了。如果有钱的话会考虑4卡Titan X类似的配置，但也会考虑8卡的机器。

## 总结

折腾硬件就跟其他很多事情一样，要么有钱，要么得有时间折腾。对各位玩家的建议是，如果只是上一两台，可以在newegg上多选多看，但如果是准备买数十台，建议还是用整体方案，例如asus和supermicro都是不错的选择。happy hacking!
